#!/bin/bash

git fetch upstream

if [[ $? != 0 ]]; then
  echo "Unable to fetch upstream, perhaps there is no remote named upstream?"
  exit 1
fi

username=$(git config user.email | cut -d"@" -f 1 )
cur_branch=$(git branch --show-current)
reviewers=$(git config --get-all pr.reviewers)

git checkout master
git pull --rebase upstream master
git push origin master

git checkout $cur_branch
git pull --rebase upstream master

function join {
  local d=$1;
  shift;
  local f=$1;
  shift;
  printf %s "$f" "${@/#/$d}";
}

BODY="$(git log -1 --pretty=%B)"

if [[ ! -z $JIRA_URL ]]; then
  BODY="$BODY\n\n$JIRA_URL/browse/$cur_branch"
fi

if [ -z $reviewers ]; then

  gh pr create -t $cur_branch -b $BODY -w

else

  gh pr create -t $cur_branch -b $BODY --reviewer $(join , $reviewers)

fi
