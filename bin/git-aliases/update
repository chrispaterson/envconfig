#!/bin/bash
branch=$(git branch --show-current)
to_branch="main" && [[ $# > 0 ]] && to_branch=$1

if [[ $to_branch == $branch ]]; then
  echo "Can not merge from $branch to $to_branch because they are the same"
  exit 1
fi

read -p "Do you want to get changes from $to_branch? [Y/n] " -n 1 -r
echo    # move to a new line

if ! [[ $reply =~ ^[Yy]$ || -z $reply ]]
then
  echo "It's cool, we all make mistakes..."
  exit 

fi

cd $(git root)
git fetch
git merge origin/$to_branch


conflicts=$(git diff --name-status --diff-filter=U)

if [[ -z "$conflicts" ]]; then
  if [[ -f ./rush.json ]]; then

    git checkout $to_branch -- common/config/rush/pnpm-lock.yaml common/config/rush/repo-state.json
    rush update
    git add common/config/rush/pnpm-lock.yaml
    git add common/config/rush/repo-state.json
  fi
  git commit --no-edit
fi

cd -
